<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="meta-title">Blog | Adlai Dyson | Fused Frame Photography</title>
    <meta name="description" id="meta-desc" content="Photography insights, technical guides, and project updates from Adlai Dyson.">
    <link rel="icon" href="https://cdn-eu.fusedframe.co.uk/main-logos/jpg/squarefavicon-nocircle.jpg">
    
    <!-- Analytics: Umami -->
    <script src="https://analytics.adffp.uk/script.js" data-website-id="c490b3f9-34ee-485d-b09a-5f869f545a12"></script>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        .prose img { border-radius: 0.75rem; margin: 2rem 0; border: 1px solid #1e293b; }
        .prose a { color: #94fdf8; text-decoration: none; font-weight: 500; }
        .prose a:hover { text-decoration: underline; }
        .prose h1, .prose h2, .prose h3 { color: #f8fafc; font-weight: 700; margin-top: 2em; margin-bottom: 0.5em; }
        .prose h1 { font-size: 1.875rem; }
        .prose p { margin-bottom: 1.25em; line-height: 1.8; color: #cbd5e1; }
        .brand-glow { text-shadow: 0 0 20px rgba(148, 253, 248, 0.2); }
        .card-hover:hover { border-color: #94fdf8; box-shadow: 0 0 25px rgba(148, 253, 248, 0.05); }
        input:focus { outline: none; border-color: #94fdf8 !important; box-shadow: 0 0 10px rgba(148, 253, 248, 0.1); }
        #cusdis_thread iframe { width: 100% !important; color-scheme: dark; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen flex flex-col font-sans">

    <!-- Header -->
    <header class="border-b border-slate-900 sticky top-0 bg-slate-950/80 backdrop-blur-md z-50">
        <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
            <a href="javascript:void(0)" onclick="router.navigate('/')" class="flex items-center gap-3">
                <img src="https://cdn-eu.fusedframe.co.uk/main-logos/png/squarelogo-light-crop.png" alt="FFP" class="h-10 w-auto">
                <span class="font-bold text-xl tracking-tight hidden sm:inline uppercase">Blog</span>
            </a>
            <nav class="flex gap-6 text-sm font-medium text-slate-400">
                <a href="https://www.fusedframe.co.uk" class="hover:text-white transition">Main Site</a>
                <a href="javascript:void(0)" onclick="router.navigate('/')" class="text-[#94fdf8]">Post Feed</a>
            </nav>
        </div>
    </header>

    <main class="flex-grow max-w-5xl mx-auto px-6 py-12 w-full">
        <div id="app">
            <!-- Loading State -->
            <div id="loading" class="flex flex-col items-center justify-center py-20">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-[#94fdf8] mb-4"></div>
                <p class="text-slate-500">Developing frames...</p>
            </div>

            <!-- List View -->
            <div id="list-view" class="hidden">
                <div class="mb-12">
                    <h1 class="text-4xl md:text-5xl font-bold mb-4 brand-glow">Posts</h1>
                    <p class="text-slate-400 text-lg mb-8">Photography insights and technical logs.</p>
                    
                    <div class="flex flex-col md:flex-row gap-4 items-start md:items-center justify-between bg-slate-900/50 p-4 rounded-xl border border-slate-800">
                        <input type="text" id="search-input" placeholder="Search posts..." 
                            class="w-full md:max-w-md bg-slate-950 border border-slate-800 rounded-lg px-4 py-2 text-sm text-slate-200">
                        <select id="sort-select" class="bg-slate-950 border border-slate-800 rounded-lg px-3 py-2 text-sm text-slate-300">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                        </select>
                    </div>
                </div>

                <div id="category-filter" class="flex flex-wrap gap-2 mb-8"></div>
                <div id="posts-grid" class="grid gap-8 sm:grid-cols-2"></div>
            </div>

            <!-- Single Post View -->
            <div id="post-view" class="hidden">
                <button onclick="router.navigate('/')" class="mb-8 text-sm text-slate-500 hover:text-[#94fdf8] flex items-center gap-2 transition">
                    ← Back to feed
                </button>
                <article>
                    <div class="mb-10">
                        <div id="post-meta-tags" class="flex flex-wrap items-center gap-3 text-xs text-[#94fdf8] font-mono mb-4 uppercase tracking-widest"></div>
                        <h1 id="post-title" class="text-4xl md:text-6xl font-bold mb-6 leading-tight"></h1>
                        <div class="flex items-center justify-between border-t border-slate-900 pt-6">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center text-xs font-bold text-slate-400">AD</div>
                                <div>
                                    <p class="text-sm font-semibold text-slate-200" id="author-name"></p>
                                    <p class="text-xs text-slate-500" id="post-date-full"></p>
                                </div>
                            </div>
                            <div id="read-time" class="text-xs text-slate-600 font-mono"></div>
                        </div>
                    </div>
                    
                    <div id="post-content" class="prose max-w-none mb-12 border-b border-slate-900 pb-12"></div>

                    <!-- Socials & Comments -->
                    <div class="flex flex-wrap gap-3 mb-12">
                        <button id="share-tw" class="share-btn bg-slate-900 border border-slate-800 px-4 py-2 rounded-lg text-sm flex items-center gap-2 hover:bg-slate-800 transition">X / Twitter</button>
                        <button id="share-copy" class="share-btn bg-slate-900 border border-slate-800 px-4 py-2 rounded-lg text-sm flex items-center gap-2 hover:bg-[#94fdf8] hover:text-slate-950 transition">Copy Link</button>
                    </div>

                    <div class="bg-slate-900/30 p-8 rounded-2xl border border-slate-900">
                        <h3 class="text-xl font-bold mb-8">Comments</h3>
                        <div id="cusdis_thread"
                            data-host="https://bcomments.adffp.uk"
                            data-app-id="a8d705af-b57b-483a-81cf-7177d83d6b5a"
                        ></div>
                        <script async defer src="https://bcomments.adffp.uk/js/cusdis.es.js"></script>
                    </div>
                </article>
            </div>
        </div>
    </main>

    <footer class="mt-20 py-10 border-t border-slate-900 text-center text-sm text-slate-500">
        <p class="font-medium text-slate-400">© Adlai Dyson | Fused Frame Photography</p>
        <p class="text-xs mt-2">Running on blog.fusedframe.co.uk</p>
    </footer>

    <script>
        // List of .md files in your /posts/ folder
        const postIds = [
            'introducing-blog',
            'making-exif-overlay'
        ];

        const state = {
            posts: [],
            currentFilter: 'All',
            searchQuery: '',
            sortBy: 'newest'
        };

        const router = {
            navigate: (path) => {
                const url = new URL(window.location);
                if (path === '/') url.searchParams.delete('p');
                else url.searchParams.set('p', path);
                window.history.pushState({}, '', url);
                handleRoute();
            }
        };

        async function fetchPost(id) {
            try {
                const response = await fetch(`./posts/${id}.md`);
                if (!response.ok) throw new Error(`Could not fetch ${id}`);
                const text = await response.text();
                
                const lines = text.split('\n');
                const meta = {};
                const bodyLines = [];
                let finishedMeta = false;

                for (let line of lines) {
                    const trimmed = line.trim();
                    // Detect your specific metadata headers: ## key: value
                    const metaMatch = trimmed.match(/^##\s*([^:]+):\s*(.*)$/);
                    
                    if (!finishedMeta && metaMatch) {
                        const key = metaMatch[1].trim().toLowerCase();
                        const value = metaMatch[2].trim();
                        meta[key] = value;
                    } else {
                        // Once we hit a line that isn't metadata, treat rest as body
                        if (trimmed !== '') finishedMeta = true; 
                        bodyLines.push(line);
                    }
                }

                const content = bodyLines.join('\n').trim();
                const dateTimeStr = meta.date ? (meta.time ? `${meta.date} ${meta.time}` : `${meta.date} 00:00`) : '1970-01-01 00:00';
                const sortTimestamp = new Date(dateTimeStr).getTime();
                
                // Handle multiple categories
                const categories = meta.category 
                    ? meta.category.split(',').map(c => c.trim()) 
                    : ['Uncategorized'];

                return {
                    id,
                    title: meta.title || 'Untitled Post',
                    date: meta.date || 'Unknown Date',
                    sortTimestamp: isNaN(sortTimestamp) ? 0 : sortTimestamp,
                    author: meta.author || 'Adlai Dyson',
                    categories,
                    excerpt: meta.excerpt || content.substring(0, 150).replace(/[#*`]/g, '') + '...',
                    content,
                    readTime: Math.ceil(content.split(/\s+/).length / 200) || 1
                };
            } catch (e) {
                console.warn(`Error processing post ${id}:`, e);
                return null;
            }
        }

        async function init() {
            const results = await Promise.all(postIds.map(fetchPost));
            state.posts = results.filter(p => p !== null);
            
            document.getElementById('search-input').oninput = (e) => {
                state.searchQuery = e.target.value.toLowerCase();
                renderList();
            };
            document.getElementById('sort-select').onchange = (e) => {
                state.sortBy = e.target.value;
                renderList();
            };

            handleRoute();
        }

        function handleRoute() {
            const params = new URLSearchParams(window.location.search);
            const postId = params.get('p');
            
            document.getElementById('loading').classList.add('hidden');
            
            if (postId && state.posts.find(p => p.id === postId)) {
                showPost(postId);
            } else {
                showList();
            }
            window.scrollTo(0, 0);
        }

        function showList() {
            document.getElementById('post-view').classList.add('hidden');
            document.getElementById('list-view').classList.remove('hidden');
            renderList();
        }

        function renderList() {
            const grid = document.getElementById('posts-grid');
            const filterContainer = document.getElementById('category-filter');
            
            const allCats = ['All', ...new Set(state.posts.flatMap(p => p.categories))];
            filterContainer.innerHTML = allCats.map(cat => `
                <button onclick="setFilter('${cat}')" class="px-4 py-1.5 rounded-full text-xs font-medium border ${state.currentFilter === cat ? 'bg-[#94fdf8] text-slate-950 border-[#94fdf8]' : 'border-slate-800 text-slate-400 hover:border-slate-600'} transition">
                    ${cat}
                </button>
            `).join('');

            let filtered = state.posts.filter(p => {
                const matchesCat = state.currentFilter === 'All' || p.categories.includes(state.currentFilter);
                const matchesSearch = p.title.toLowerCase().includes(state.searchQuery) || p.excerpt.toLowerCase().includes(state.searchQuery);
                return matchesCat && matchesSearch;
            });

            filtered.sort((a, b) => state.sortBy === 'newest' ? b.sortTimestamp - a.sortTimestamp : a.sortTimestamp - b.sortTimestamp);

            grid.innerHTML = filtered.map(post => `
                <article onclick="router.navigate('${post.id}')" class="group cursor-pointer bg-slate-900 border border-slate-800 rounded-2xl p-6 transition card-hover">
                    <div class="text-[10px] font-bold tracking-widest uppercase mb-4 text-[#94fdf8]">
                        ${post.categories.join(' / ')} • ${post.date}
                    </div>
                    <h2 class="text-2xl font-bold mb-3 group-hover:text-[#94fdf8] transition">${post.title}</h2>
                    <p class="text-slate-400 text-sm mb-6 line-clamp-2">${post.excerpt}</p>
                    <div class="flex justify-between items-center text-xs font-mono text-slate-500">
                        <span>Read Post →</span>
                        <span>${post.readTime} min read</span>
                    </div>
                </article>
            `).join('');
        }

        function setFilter(cat) { state.currentFilter = cat; renderList(); }

        function showPost(id) {
            const post = state.posts.find(p => p.id === id);
            document.getElementById('list-view').classList.add('hidden');
            document.getElementById('post-view').classList.remove('hidden');
            
            document.getElementById('post-title').innerText = post.title;
            document.getElementById('post-meta-tags').innerHTML = post.categories.join(' <span class="text-slate-700">/</span> ') + ` <span class="text-slate-700">/</span> ` + post.date;
            document.getElementById('author-name').innerText = post.author;
            document.getElementById('post-date-full').innerText = `Published ${post.date}`;
            document.getElementById('read-time').innerText = `${post.readTime} min read`;
            document.getElementById('post-content').innerHTML = marked.parse(post.content);

            // Update Socials
            const url = window.location.href;
            document.getElementById('share-tw').onclick = () => window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(post.title)}&url=${encodeURIComponent(url)}`);
            document.getElementById('share-copy').onclick = () => {
                navigator.clipboard.writeText(url).then(() => {
                    const btn = document.getElementById('share-copy');
                    btn.innerText = "Link Copied!";
                    setTimeout(() => btn.innerText = "Copy Link", 2000);
                });
            };

            // Update Comments
            if (window.renderCusdis) {
                const thread = document.getElementById('cusdis_thread');
                thread.dataset.pageId = post.id;
                thread.dataset.pageUrl = url;
                thread.dataset.pageTitle = post.title;
                window.renderCusdis(thread);
            }
        }

        window.onpopstate = handleRoute;
        init();
    </script>
</body>
</html>